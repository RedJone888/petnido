// -----------------------
//  Prisma Generators
// -----------------------
generator client {
  provider = "prisma-client-js"
}

// -----------------------
//  Data Source
// -----------------------
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
// -----------------------
//  Enums
// -----------------------
enum UserRole {
  USER
  ADMIN
}

enum PetType {
  DOG
  CAT
  RABBIT
  BIRD
  CHINCHILLA
  GUINEA_PIG
  HAMSTER
  OTHER
}

enum NeedStatus {
  OPEN
  MATCHED
  CLOSED
  CANCELLED
}

enum ServiceCategory {
  VISIT   // 上门喂养
  FOSTER  // 家庭寄养
  OTHER   // 通用/其他
}

enum AvailabilityRangeType {
  LONG_TERM
  DATE_RANGE
}
enum AvailabilityWeekPattern {
  EVERYDAY
  WEEKDAYS_ONLY
  WEEKENDS_ONLY
}

enum PriceUnit {
  DAY      // 1日あたり
  HOUR     // 1時間あたり
  VISIT    // 1回あたり（ドロップインなど）
}
enum Currency {
  JPY
  USD
  EUR
  CNY
  TWD
  KRW
  GBP
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

// -----------------------
//  Models
// -----------------------
model User {
  id             String   @id @default(cuid())
  name           String?
  email          String?   @unique
  emailVerified  DateTime?
  image     String?
  password  String? // (可选，OAuth用户无需密码)
  role      UserRole @default(USER) // 后端用，前端再用 profileType 区分

  profile   Profile?
  pets      Pet[]
  needs     Need[]
  serviceProfile  ServiceProfile?
  attachment      Attachment[]
  applications    Application[]
  sittings        Booking[] @relation("SitterBookings")
  ownerBookings   Booking[] @relation("OwnerBookings")
  messagesSent    Message[] @relation("MessagesFromUser")
  messagesReceived Message[] @relation("MessagesToUser")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  accounts Account[]
  sessions Session[]
}

model Profile {
  id        String @id @default(cuid())
  userId    String @unique
  user      User   @relation(fields: [userId], references: [id])

  bio           String?
  isSitter      Boolean @default(false)
  isOwner       Boolean @default(true)
}

model ServiceProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])

  // 用户当前主要活动区域（默认值）
  baseAreaRaw   String?    
  baseLat       Float?
  baseLon       Float?
  baseCurrency  Currency?
  
  introduction      String?
  monthsExperience   Int?

  rating        Float  @default(0)
  reviewCount   Int    @default(0)

  services  Service[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Service {
  id                String   @id @default(cuid())
  serviceProfileId  String
  serviceProfile    ServiceProfile @relation(fields: [serviceProfileId], references: [id])
 
  // 服务基本信息
  serviceType    ServiceCategory   
  customType     String?         
  description    String?
  isActive       Boolean @default(true)

  // 服务地点（独立于 profile）
  areaRaw   String 
  areaLat   Float
  areaLon   Float
  currency  Currency

  photos         Attachment[]

  // 可用时间
  availabilityRangeType   AvailabilityRangeType
  availabilityWeekPattern AvailabilityWeekPattern
  includeHolidays         Boolean @default(false)
  availableFrom           DateTime? 
  availableTo             DateTime? 

  // 价格
  priceUnit   PriceUnit
  priceRules      PriceRule[]

  // 可服务宠物（系统推断）
  petTypes PetType[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model PriceRule {
  id          String     @id @default(cuid())
  serviceId   String
  service     Service    @relation(fields: [serviceId], references: [id])

  groupLabel  String
  price       Int       @default(0)
}
enum ServicePhotoKind {
  EXPERIENCE
  HOME
}

model Attachment {
  id        String           @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  url         String           // 先存URL；后续接R2/S3
  fileKey     String
  order       Int @default(0)
  status      Int @default(0) //0：TEMP  1：ACTIVE  2：DELETED
  signature   String
  serviceKind ServicePhotoKind?

  createdAt   DateTime         @default(now())

  serviceId String?
  service   Service? @relation(fields: [serviceId],references: [id],onDelete: Cascade)
  needId    String?
  need      Need? @relation(fields:[needId],references:[id],onDelete:Cascade)
  petId     String?
  pet       Pet? @relation(fields:[petId],references:[id],onDelete:Cascade)
  needPetId String?
  needPet   NeedPet? @relation(fields:[needPetId],references:[id],onDelete:Cascade)
}

enum FrequencyType {
  ONCE_A_DAY
  TWICE_A_DAY
  EVERY_2_DAYS
  EVERY_3_DAYS
  CUSTOM
}
enum DistanceRange {
  WITHIN_3KM
  WITHIN_5KM
  WITHIN_10KM
  NO_LIMIT
}
enum TransportMethod {
  SELF
  SITTER
  TAXI
  DISCUSS
}
model Need {
  id        String       @id @default(cuid())
  ownerId   String
  owner     User     @relation(fields: [ownerId], references: [id])

  title         String
  category      ServiceCategory
  // 需求与备注
  requirement  String
  // 时间与频率
  startDate    DateTime
  endDate      DateTime
  // 仅在 VISIT 模式下有效
  frequencyType   FrequencyType? 
  customDays      Int?
  customTimes     Int? 
  
  // 地点逻辑
  addressRaw   String
  addressLat   Float
  addressLon   Float
  currency     Currency
  // 仅在 FOSTER 模式下有效
  fosterRange     DistanceRange?
  transportMethod TransportMethod?
  status          NeedStatus @default(OPEN)
  
  // 关联
  needPets     NeedPet[]
  photos       Attachment[]
  
  // 价格体系
  priceAmount  Int?         // 单价
  totalPrice   Int          // 最终显示给用户的总价（由前端计算或手动输入后传回）
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  applications  Application[]
  bookings      Booking[]
}

model NeedPet {
  id        String @id @default(cuid())
  needId    String
  need      Need @relation(fields:[needId],references:[id])
  petCategory PetType
  petType     String?
  count       Int
  description String?
  photos      Attachment[]
  tags        String[]
  petIds      String[]
}
model Pet {
  id        String   @id @default(cuid())
  ownerId   String
  owner     User     @relation(fields: [ownerId], references: [id])

  name      String?
  type      PetType
  breed     String?
  age       Int?
  photos    Attachment[]
  notes     String?

  createdAt DateTime @default(now())
}

model Application {
  id        String  @id @default(cuid())
  needId    String
  need      Need    @relation(fields: [needId], references: [id])

  sitterId  String
  sitter    User    @relation(fields: [sitterId], references: [id])

  message   String?
  status    ApplicationStatus @default(PENDING)
  price     Float    @default(0)

  createdAt DateTime @default(now())
}

model Booking {
  id        String   @id @default(cuid())
  // 可选：从一个需求帖发起, 可选：从一个服务帖发起
  needId    String?
  need      Need?    @relation(fields: [needId], references: [id])
  // 双方用户
  ownerId   String
  owner     User     @relation("OwnerBookings", fields: [ownerId], references: [id])
  
  sitterId  String
  sitter    User     @relation("SitterBookings", fields: [sitterId], references: [id])

  startDate DateTime
  endDate   DateTime
  price     Float    @default(0)
  status    BookingStatus @default(CONFIRMED)

  createdAt DateTime @default(now())
}

model Message {
  id        String   @id @default(cuid())
  fromId    String
  from      User     @relation("MessagesFromUser", fields: [fromId], references: [id])

  toId      String
  to        User     @relation("MessagesToUser", fields: [toId], references: [id])

  content   String
  createdAt DateTime @default(now())

  // 可以再加 conversationId 做会话归类
}

// -----------------------
//  NextAuth Models
// -----------------------
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     Json?

  user User @relation(fields: [userId], references: [id])

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id])
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}